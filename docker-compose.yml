version: '3.4'
services:
  mosquitto:
    image: eclipse-mosquitto
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/logs
    ports:
      - "1883:1883"
      - "9001:9001"
 
  openplc:
    build:
      context: .
      dockerfile: openplc/Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: openplc
    ports:
      - "8080:8080"
    privileged: true

  scadabr:
    build:
      context: .
      dockerfile: scadabr/Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: scadabr
    ports:
      - "9090:9090"

  node-red:
    build:
      context: node-red
      dockerfile: Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: node-red
    ports:
      - "1880:1880"
    depends_on:
      - mosquitto
    environment:
      - DEBUG=contribModbus*
  
  level-high-switch:
    build:
      context: opcua
      dockerfile: Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: opcua
    command: "/root/examples/tutorial_pubsub_mqtt_publish --url opc.mqtt://mosquitto:1883 --topic level-high-switch --freq 5000 --json --id level-high-switch"
    depends_on:
      - mosquitto

  level-low-switch:
    build:
      context: opcua
      dockerfile: Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: opcua
    command: "/root/examples/tutorial_pubsub_mqtt_publish --url opc.mqtt://mosquitto:1883 --topic level-low-switch --freq 5000 --json --id level-low-switch"
    depends_on:
      - mosquitto

  inlet-valve:
    build:
      context: opcua
      dockerfile: Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: opcua
    command: "/root/examples/tutorial_pubsub_mqtt_subscribe --url opc.mqtt://mosquitto:1883 --topic inlet-valve --id inlet-valve"
    depends_on:
      - mosquitto

  outlet-valve:
    build:
      context: opcua
      dockerfile: Dockerfile
      args:
        http_proxy: "${http_proxy:-}"
        https_proxy: "${https_proxy:-}"
    image: opcua
    command: "/root/examples/tutorial_pubsub_mqtt_subscribe --url opc.mqtt://mosquitto:1883 --topic outlet-valve --id outlet-valve"
    depends_on:
      - mosquitto

volumes:
  mosquitto-data:
  mosquitto-log:
